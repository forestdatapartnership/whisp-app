name: Update Release Tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to move (e.g., v1.2.3)'
        required: true
        type: string

jobs:
  retag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TAG: ${{ github.event.inputs.tag }}
      RELEASE_BRANCH: release/${{ github.event.inputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "$TAG" >/dev/null

      - name: Move tag to release branch head
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin "$RELEASE_BRANCH" || { echo "Release branch $RELEASE_BRANCH not found" >&2; exit 1; }
          git tag -d "$TAG" 2>/dev/null || true
          git push origin ":refs/tags/$TAG" || true
          git checkout "$RELEASE_BRANCH"
          git tag -a "$TAG" -m "Update release $TAG"
          git push origin "$TAG"

      - name: Update GitHub release to new tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "$TAG" \
            --tag "$TAG"

